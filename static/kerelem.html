<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kérelem Generátor</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f4f4f4;
            margin: 0;
            padding: 0;
        }

        .container {
            width: 80vw;
            max-width: 900px;
            margin: 2rem auto;
            background: #fff;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        h1 {
            text-align: center;
        }

        label {
            display: block;
            margin-top: 1rem;
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 0.5rem;
            margin-top: 0.3rem;
            box-sizing: border-box;
        }

        canvas {
            border: 1px solid #333;
            display: block;
            margin: 1rem 0;
            touch-action: none;
        }

        .actions {
            text-align: center;
            margin-top: 2rem;
        }

        button {
            padding: 0.7rem 2rem;
            margin: 0 0.5rem;
        }

        @media (max-width: 600px) {
            .container {
                max-width: 90vw;
                padding: 0.5rem;
                border-radius: 0;
                box-shadow: none;
            }

            h1 {
                font-size: 1.3rem;
            }

            label {
                font-size: 1rem;
                margin-top: 0.7rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Kérelem Generátor</h1>
        <form id="requestForm">
            <label>Szülő neve <input name="parentName" required></label>
            <label>Csoport <input name="group" required></label>
            <label>Gyermek neve <input name="childName" required></label>
            <label>Indok <input name="reason" required></label>
            <label>Kezdő dátum <input type="date" name="fromDate" required></label>
            <label>Vég dátum <input type="date" name="toDate" required></label>
            <label>Aláírás (rajzold le):</label>
            <canvas id="signature" width="280" height="150"></canvas>
            <button type="button" onclick="clearSignature()">Törlés</button>
            <label>Export formátum
                <select name="format">
                    <option value="pdf">PDF</option>
                    <option value="image">Kép (JPEG)</option>
                </select>
            </label>
            <div class="actions">
                <button type="submit">Generálás</button>
            </div>
        </form>
    <div id="validationMsg" style="color: red; margin-top: 1rem;"></div>
    <div id="result"></div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
    // Hungarian date formatting function
    function formatDateHungarian(date, removeTrailingDot = false) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}. ${month}. ${day}${removeTrailingDot ? '' : '.'}`;
    }
    
    // Signature canvas logic with caching and smoothing
    const canvas = document.getElementById('signature');
    const ctx = canvas.getContext('2d');
    ctx.strokeStyle = '#1a237e'; // ink-like color
    ctx.lineWidth = 2;
    let drawing = false;
    let points = [];
    // Load cached signature if exists
    const cachedSignature = localStorage.getItem('kerelem_signature');
    if (cachedSignature) {
        const img = new window.Image();
        img.onload = function() { ctx.drawImage(img, 0, 0); };
        img.src = cachedSignature;
    }
    function getPos(e) {
        const rect = canvas.getBoundingClientRect();
        if (e.touches) {
            return { x: e.touches[0].clientX - rect.left, y: e.touches[0].clientY - rect.top };
        } else {
            return { x: e.clientX - rect.left, y: e.clientY - rect.top };
        }
    }
    function drawSmoothLine() {
        if (points.length < 3) {
            const p = points[0];
            ctx.beginPath();
            ctx.arc(p.x, p.y, ctx.lineWidth / 2, 0, 2 * Math.PI, true);
            ctx.fill();
            ctx.closePath();
            return;
        }
        ctx.beginPath();
        ctx.moveTo(points[0].x, points[0].y);
        for (let i = 1; i < points.length - 2; i++) {
            const c = (points[i].x + points[i + 1].x) / 2;
            const d = (points[i].y + points[i + 1].y) / 2;
            ctx.quadraticCurveTo(points[i].x, points[i].y, c, d);
        }
        ctx.quadraticCurveTo(
            points[points.length - 2].x,
            points[points.length - 2].y,
            points[points.length - 1].x,
            points[points.length - 1].y
        );
        ctx.stroke();
    }
    canvas.addEventListener('mousedown', e => {
        drawing = true;
        points = [getPos(e)];
    });
    canvas.addEventListener('touchstart', e => {
        e.preventDefault(); // Prevent scrolling and pull-to-refresh
        drawing = true;
        points = [getPos(e)];
    });
    canvas.addEventListener('mouseup', e => {
        drawing = false;
        localStorage.setItem('kerelem_signature', canvas.toDataURL('image/png'));
    });
    canvas.addEventListener('touchend', e => {
        e.preventDefault(); // Prevent default touch behavior
        drawing = false;
        localStorage.setItem('kerelem_signature', canvas.toDataURL('image/png'));
    });
    canvas.addEventListener('mousemove', e => {
        if (!drawing) return;
        points.push(getPos(e));
        drawSmoothLine();
    });
    canvas.addEventListener('touchmove', e => {
        e.preventDefault(); // Prevent scrolling while drawing
        if (!drawing) return;
        points.push(getPos(e));
        drawSmoothLine();
    });
    
    // Prevent context menu and other unwanted behaviors on canvas
    canvas.addEventListener('contextmenu', e => e.preventDefault());
    canvas.addEventListener('selectstart', e => e.preventDefault());
    canvas.addEventListener('dragstart', e => e.preventDefault());
    
    // Additional touch event protection for mobile
    canvas.addEventListener('touchcancel', e => {
        e.preventDefault();
        drawing = false;
    });
    window.clearSignature = function() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        localStorage.removeItem('kerelem_signature');
    }

    // Cache form values on change
    const form = document.getElementById('requestForm');
    ['parentName','group','childName','reason','fromDate','toDate'].forEach(name => {
        const input = form[name];
        input.value = localStorage.getItem('kerelem_' + name) || '';
        input.addEventListener('input', () => {
            localStorage.setItem('kerelem_' + name, input.value);
        });
    });

    // Ensure toDate is >= fromDate when fromDate changes
    form.fromDate.addEventListener('change', () => {
        const fromDate = form.fromDate.value;
        const toDate = form.toDate.value;
        if (fromDate && toDate && toDate < fromDate) {
            form.toDate.value = fromDate;
            localStorage.setItem('kerelem_toDate', fromDate);
        }
    });

    // Cache preferred download type
    const formatSelect = form.format;
    formatSelect.value = localStorage.getItem('kerelem_format') || 'pdf';
    formatSelect.addEventListener('change', () => {
        localStorage.setItem('kerelem_format', formatSelect.value);
    });

    // Cache signature on change
    canvas.addEventListener('mouseup', () => {
        localStorage.setItem('kerelem_signature', canvas.toDataURL('image/png'));
    });
    canvas.addEventListener('touchend', () => {
        localStorage.setItem('kerelem_signature', canvas.toDataURL('image/png'));
    });

    form.onsubmit = async function(e) {
        e.preventDefault();
        // Validation
        const parentName = form.parentName.value.trim();
        const group = form.group.value.trim();
        const childName = form.childName.value.trim();
        const reason = form.reason.value.trim();
        const fromDate = form.fromDate.value;
        const toDate = form.toDate.value;
        const format = form.format.value;
        let valid = true;
        let msg = '';
        if (!parentName || !group || !childName || !reason || !fromDate || !toDate) {
            valid = false;
            msg = 'Minden mező kitöltése kötelező!';
        } else if (toDate < fromDate) {
            valid = false;
            msg = 'A vég dátum nem lehet korábbi, mint a kezdő dátum!';
        }
        if (!localStorage.getItem('kerelem_signature')) {
            valid = false;
            msg = 'Kérjük, rajzolja le az aláírást!';
        }
        document.getElementById('validationMsg').textContent = msg;
        if (!valid) return;
        // Calculate onDate (one day before fromDate)
        let onDate = '';
        if (fromDate) {
            const d = new Date(fromDate);
            d.setDate(d.getDate() - 1);
            onDate = formatDateHungarian(d);
        }
        
        // Format dates to Hungarian
        const fromDateHu = formatDateHungarian(new Date(fromDate), true);
        const toDateHu = formatDateHungarian(new Date(toDate), true);
        // Get signature image
        const signatureData = canvas.toDataURL('image/png'); // Keep PNG for signature transparency
        localStorage.setItem('kerelem_signature', signatureData);
        // Compose document HTML
        const docHtml = `
        <div id="exportDoc" style="font-family: Arial; color: #222; width: 900px; padding: 45px 150px 75px; background: #fff; box-sizing: border-box;">
            <h2 style="text-align:center;">KÉRELEM</h2>
            <p>Alulírott <b>${parentName}</b> (szülő neve) azzal a kéréssel fordulok a <b>${group}</b> csoport óvodapedagógusához, hogy a Nagybácsai Óvoda Kisbácsai Tagóvodájában jogviszonnyal rendelkező <b>${childName}</b> nevű gyermekem távolmaradását <b>${reason}</b> ok miatt, <b>${fromDateHu}</b>-tól <b>${toDateHu}</b>-ig engedélyezni szíveskedjen.</p>
            <br><br>
            <div style="display:flex; justify-content:space-between;">
                <div>Győr, <b>${onDate}</b></div>
                <div style="text-align:center;">
                    <img src="${signatureData}" style="height:50px; display:block; margin:auto;">
                    <div style="text-align:center; border-top:2px dotted #222; width:200px; padding-top:20px;">szülő aláírása</div>
                </div>
            </div>
            <br><br>
            <div>Távolmaradását engedélyezem:</div>
            <div style="display:flex; justify-content:space-between; margin-top:2rem;">
                <div>Győr,</div>
                <div style="text-align:center; border-top:2px dotted #222; width:200px; padding-top:20px;">óvodapedagógus</div>
            </div>
        </div>`;
        const resultDiv = document.getElementById('result');
        resultDiv.innerHTML = '';
        const temp = document.createElement('div');
        temp.style.position = 'fixed';
        temp.style.left = '-9999px';
        temp.innerHTML = docHtml;
        document.body.appendChild(temp);
        const exportDoc = temp.querySelector('#exportDoc');
        const rect = exportDoc.getBoundingClientRect();
        const exportWidth = Math.ceil(rect.width);
        const exportHeight = Math.ceil(rect.height);
        
        // Generate consistent filename base
        const fileNameBase = `kerelem_${fromDate}_${toDate}`;
        
        if (format === 'pdf') {
            const { jsPDF } = window.jspdf;
            // Use A4 landscape
            const pdf = new jsPDF({ orientation: 'landscape', unit: 'px', format: 'a4' });
            const pageWidth = pdf.internal.pageSize.getWidth();
            const pageHeight = pdf.internal.pageSize.getHeight();
            await html2canvas(exportDoc, { scale: 2, width: exportWidth, height: exportHeight }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                // Calculate scale to fit image to page
                const scale = Math.min(pageWidth / exportWidth, pageHeight / exportHeight);
                const imgW = exportWidth * scale;
                const imgH = exportHeight * scale;
                const x = (pageWidth - imgW) / 2;
                const y = (pageHeight - imgH) / 2;
                pdf.addImage(imgData, 'PNG', x, y, imgW, imgH);
                pdf.save(`${fileNameBase}.pdf`);
            });
        } else {
            await html2canvas(exportDoc, { scale: 2, width: exportWidth, height: exportHeight }).then(canvas => {
                const imgData = canvas.toDataURL('image/jpeg', 0.95); // JPEG with 95% quality
                const link = document.createElement('a');
                link.href = imgData;
                link.download = `${fileNameBase}.jpg`;
                link.click();
            });
        }
        document.body.removeChild(temp);
    }
    </script>
</body>
</html>
